#!/bin/bash

# {{PROJECT_NAME}} - ç¶œåˆæª¢æŸ¥è…³æœ¬
# åŸ·è¡Œæ‰€æœ‰å°ˆæ¡ˆæª¢æŸ¥é …ç›®

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å°ˆæ¡ˆæ ¹ç›®éŒ„
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SOURCE_DIR="${PROJECT_ROOT}/{{SOURCE_DIR}}"

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘     {{PROJECT_NAME}} å°ˆæ¡ˆæª¢æŸ¥å·¥å…·      â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# è¨ˆæ•¸å™¨
TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0

# æª¢æŸ¥å‡½æ•¸
run_check() {
    local check_name="$1"
    local check_command="$2"
    
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    echo -n -e "${YELLOW}â–¶ ${check_name}...${NC} "
    
    if eval "$check_command" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“ é€šé${NC}"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
    else
        echo -e "${RED}âœ— å¤±æ•—${NC}"
        FAILED_CHECKS=$((FAILED_CHECKS + 1))
        # é¡¯ç¤ºè©³ç´°éŒ¯èª¤ï¼ˆå¯é¸ï¼‰
        # eval "$check_command" 2>&1 | head -5
    fi
}

# åŸ·è¡Œå„é …æª¢æŸ¥
echo -e "${BLUE}é–‹å§‹åŸ·è¡Œæª¢æŸ¥...${NC}\n"

# 1. ä»£ç¢¼å“è³ªæª¢æŸ¥
echo -e "${BLUE}[ä»£ç¢¼å“è³ªæª¢æŸ¥]${NC}"
run_check "æª¢æŸ¥ä»£ç¢¼æ ¼å¼" "./validation-scripts/check-code-quality.sh"
run_check "æª¢æŸ¥æª”æ¡ˆå¤§å°" "! find $SOURCE_DIR -name '*.{{FILE_EXT}}' -exec wc -l {} + | awk '\$1 > {{MAX_FILE_LINES}}'"
run_check "æª¢æŸ¥æ–¹æ³•é•·åº¦" "./validation-scripts/check-method-length.sh"
echo

# 2. æ¶æ§‹åˆè¦æª¢æŸ¥
echo -e "${BLUE}[æ¶æ§‹åˆè¦æª¢æŸ¥]${NC}"
run_check "æª¢æŸ¥é‡è¤‡ä»£ç¢¼" "./validation-scripts/check-duplicates.sh"
run_check "æª¢æŸ¥é­”æ³•æ•¸å­—" "! grep -r '[0-9]\{3,\}' $SOURCE_DIR --include='*.{{FILE_EXT}}' | grep -v '{{CONSTANTS_DIR}}'"
run_check "æª¢æŸ¥ç¡¬ç·¨ç¢¼å­—ä¸²" "./validation-scripts/check-hardcoded-strings.sh"
echo

# 3. å®‰å…¨æª¢æŸ¥
echo -e "${BLUE}[å®‰å…¨æª¢æŸ¥]${NC}"
run_check "æª¢æŸ¥æ•æ„Ÿè³‡è¨Š" "./validation-scripts/check-security.sh"
run_check "æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ä½¿ç”¨" "! grep -r 'password\|secret\|key' $SOURCE_DIR --include='*.{{FILE_EXT}}' | grep -v '.env'"
echo

# 4. ä¾è³´æª¢æŸ¥
echo -e "${BLUE}[ä¾è³´æª¢æŸ¥]${NC}"
run_check "æª¢æŸ¥éæ™‚çš„ä¾è³´" "./validation-scripts/check-dependencies.sh"
run_check "æª¢æŸ¥æœªä½¿ç”¨çš„ä¾è³´" "./validation-scripts/check-unused-deps.sh"
echo

# 5. æ¸¬è©¦æª¢æŸ¥
echo -e "${BLUE}[æ¸¬è©¦æª¢æŸ¥]${NC}"
run_check "åŸ·è¡Œå–®å…ƒæ¸¬è©¦" "{{TEST_COMMAND}}"
run_check "æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡" "./validation-scripts/check-coverage.sh"
echo

# 6. æ–‡æª”æª¢æŸ¥
echo -e "${BLUE}[æ–‡æª”æª¢æŸ¥]${NC}"
run_check "æª¢æŸ¥ README å­˜åœ¨" "[ -f $PROJECT_ROOT/README.md ]"
run_check "æª¢æŸ¥ CLAUDE.md å­˜åœ¨" "[ -f $PROJECT_ROOT/CLAUDE.md ]"
run_check "æª¢æŸ¥ API æ–‡æª”" "./validation-scripts/check-api-docs.sh"
echo

# 7. Git æª¢æŸ¥
echo -e "${BLUE}[Git æª¢æŸ¥]${NC}"
run_check "æª¢æŸ¥æœªæäº¤çš„è®Šæ›´" "[ -z \"$(git status --porcelain)\" ]"
run_check "æª¢æŸ¥åˆ†æ”¯åç¨±è¦ç¯„" "./validation-scripts/check-branch-name.sh"
echo

# 8. å°ˆæ¡ˆç‰¹å®šæª¢æŸ¥
if [ -f "./validation-scripts/project-specific-checks.sh" ]; then
    echo -e "${BLUE}[å°ˆæ¡ˆç‰¹å®šæª¢æŸ¥]${NC}"
    source ./validation-scripts/project-specific-checks.sh
    echo
fi

# é¡¯ç¤ºçµæœæ‘˜è¦
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘              æª¢æŸ¥çµæœæ‘˜è¦              â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo
echo -e "ç¸½æª¢æŸ¥é …ç›®: ${TOTAL_CHECKS}"
echo -e "${GREEN}é€šé: ${PASSED_CHECKS}${NC}"
echo -e "${RED}å¤±æ•—: ${FAILED_CHECKS}${NC}"
echo

# è¨ˆç®—é€šéç‡
PASS_RATE=$((PASSED_CHECKS * 100 / TOTAL_CHECKS))
echo -n "é€šéç‡: "
if [ $PASS_RATE -ge 90 ]; then
    echo -e "${GREEN}${PASS_RATE}%${NC} ğŸ‰"
elif [ $PASS_RATE -ge 70 ]; then
    echo -e "${YELLOW}${PASS_RATE}%${NC} âš ï¸"
else
    echo -e "${RED}${PASS_RATE}%${NC} âŒ"
fi

# è¿”å›ç‹€æ…‹ç¢¼
if [ $FAILED_CHECKS -eq 0 ]; then
    echo -e "\n${GREEN}âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼${NC}"
    exit 0
else
    echo -e "\n${RED}âŒ æœ‰ ${FAILED_CHECKS} é …æª¢æŸ¥å¤±æ•—ï¼Œè«‹ä¿®å¾©å¾Œå†è©¦ã€‚${NC}"
    exit 1
fi